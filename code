/*
 * Mini Banking System (single-file)
 * Features:
 *  - Create account
 *  - View account
 *  - Deposit
 *  - Withdraw
 *  - Transfer between accounts
 *  - List all accounts
 *  - Save / Load accounts to file (binary)
 *
 * Compile: gcc -std=c11 -Wall -O2 -o bank main.c
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>

#define DATAFILE "bank.dat"
#define NAME_LEN 64

typedef struct {
    int id;
    char name[NAME_LEN];
    double balance;
    int pin; /* simple PIN to "authenticate" in CLI */
} Account;

/* dynamic array to hold accounts */
static Account *accounts = NULL;
static size_t account_count = 0;
static int next_id = 1;

/* -- Helpers -- */
static void wait_enter(void) {
    printf("\nPress ENTER to continue...");
    while (getchar() != '\n');
}

static Account *find_account_by_id(int id) {
    for (size_t i = 0; i < account_count; ++i) {
        if (accounts[i].id == id) return &accounts[i];
    }
    return NULL;
}

static void save_accounts(void) {
    FILE *f = fopen(DATAFILE, "wb");
    if (!f) {
        perror("Error opening data file for write");
        return;
    }
    fwrite(&next_id, sizeof(next_id), 1, f);
    fwrite(&account_count, sizeof(account_count), 1, f);
    if (account_count > 0) fwrite(accounts, sizeof(Account), account_count, f);
    fclose(f);
}

static void load_accounts(void) {
    FILE *f = fopen(DATAFILE, "rb");
    if (!f) return; /* no file yet is fine */
    fread(&next_id, sizeof(next_id), 1, f);
    fread(&account_count, sizeof(account_count), 1, f);
    if (account_count > 0) {
        accounts = malloc(account_count * sizeof(Account));
        if (!accounts) {
            fprintf(stderr, "Memory error while loading accounts\n");
            account_count = 0;
            fclose(f);
            return;
        }
        fread(accounts, sizeof(Account), account_count, f);
    }
    fclose(f);
}

static void add_account(const char *name, int pin, double initial_balance) {
    Account *tmp = realloc(accounts, (account_count + 1) * sizeof(Account));
    if (!tmp) {
        fprintf(stderr, "Memory allocation failed\n");
        return;
    }
    accounts = tmp;
    Account *a = &accounts[account_count];
    a->id = next_id++;
    strncpy(a->name, name, NAME_LEN - 1);
    a->name[NAME_LEN - 1] = '\0';
    a->balance = initial_balance;
    a->pin = pin;
    account_count++;
    save_accounts();
}

/* CLI operations */
static void cmd_create(void) {
    char name[NAME_LEN];
    int pin;
    double init;
    printf("Enter account holder name: ");
    /* read line */
    if (!fgets(name, sizeof(name), stdin)) return;
    name[strcspn(name, "\n")] = '\0';
    if (strlen(name) == 0) { printf("Name cannot be empty.\n"); return; }

    printf("Choose 4-digit PIN (numbers only): ");
    if (scanf("%d", &pin) != 1) { while(getchar() != '\n'); printf("Invalid PIN.\n"); return; }
    if (pin < 0) { printf("PIN must be positive.\n"); while(getchar() != '\n'); return; }

    printf("Initial deposit: ");
    if (scanf("%lf", &init) != 1) { while(getchar() != '\n'); printf("Invalid amount.\n"); return; }
    while(getchar() != '\n');

    add_account(name, pin, init);
    printf("Account created successfully.\n");
}

static bool authenticate(Account *a) {
    int pin;
    printf("Enter PIN for account %d: ", a->id);
    if (scanf("%d", &pin) != 1) { while(getchar() != '\n'); return false; }
    while(getchar() != '\n');
    if (pin != a->pin) {
        printf("Authentication failed.\n");
        return false;
    }
    return true;
}

static void cmd_view(void) {
    int id;
    printf("Enter account ID to view: ");
    if (scanf("%d", &id) != 1) { while(getchar() != '\n'); printf("Invalid ID.\n"); return; }
    while(getchar() != '\n');
    Account *a = find_account_by_id(id);
    if (!a) { printf("Account not found.\n"); return; }
    if (!authenticate(a)) return;
    printf("\nAccount ID: %d\nName: %s\nBalance: %.2f\n", a->id, a->name, a->balance);
}

static void cmd_deposit(void) {
    int id;
    double amt;
    printf("Enter account ID to deposit into: ");
    if (scanf("%d", &id) != 1) { while(getchar() != '\n'); printf("Invalid ID.\n"); return; }
    printf("Amount to deposit: ");
    if (scanf("%lf", &amt) != 1) { while(getchar() != '\n'); printf("Invalid amount.\n"); return; }
    while(getchar() != '\n');
    Account *a = find_account_by_id(id);
    if (!a) { printf("Account not found.\n"); return; }
    if (amt <= 0) { printf("Amount must be positive.\n"); return; }
    if (!authenticate(a)) return;
    a->balance += amt;
    save_accounts();
    printf("Deposit successful. New balance: %.2f\n", a->balance);
}

static void cmd_withdraw(void) {
    int id;
    double amt;
    printf("Enter account ID to withdraw from: ");
    if (scanf("%d", &id) != 1) { while(getchar() != '\n'); printf("Invalid ID.\n"); return; }
    printf("Amount to withdraw: ");
    if (scanf("%lf", &amt) != 1) { while(getchar() != '\n'); printf("Invalid amount.\n"); return; }
    while(getchar() != '\n');
    Account *a = find_account_by_id(id);
    if (!a) { printf("Account not found.\n"); return; }
    if (amt <= 0) { printf("Amount must be positive.\n"); return; }
    if (!authenticate(a)) return;
    if (amt > a->balance) { printf("Insufficient funds.\n"); return; }
    a->balance -= amt;
    save_accounts();
    printf("Withdrawal successful. New balance: %.2f\n", a->balance);
}

static void cmd_transfer(void) {
    int from, to;
    double amt;
    printf("Enter sender account ID: ");
    if (scanf("%d", &from) != 1) { while(getchar() != '\n'); printf("Invalid ID.\n"); return; }
    printf("Enter receiver account ID: ");
    if (scanf("%d", &to) != 1) { while(getchar() != '\n'); printf("Invalid ID.\n"); return; }
    printf("Amount to transfer: ");
    if (scanf("%lf", &amt) != 1) { while(getchar() != '\n'); printf("Invalid amount.\n"); return; }
    while(getchar() != '\n');
    Account *a_from = find_account_by_id(from);
    Account *a_to = find_account_by_id(to);
    if (!a_from || !a_to) { printf("One or both accounts not found.\n"); return; }
    if (amt <= 0) { printf("Amount must be positive.\n"); return; }
    if (!authenticate(a_from)) return;
    if (amt > a_from->balance) { printf("Insufficient funds.\n"); return; }
    a_from->balance -= amt;
    a_to->balance += amt;
    save_accounts();
    printf("Transfer successful. New balance (sender): %.2f\n", a_from->balance);
}

static void cmd_list(void) {
    printf("\n--- All Accounts (%zu) ---\n", account_count);
    for (size_t i = 0; i < account_count; ++i) {
        printf("ID: %d | Name: %s | Balance: %.2f\n", accounts[i].id, accounts[i].name, accounts[i].balance);
    }
}

static void cmd_delete(void) {
    int id;
    printf("Enter account ID to delete: ");
    if (scanf("%d", &id) != 1) { while(getchar() != '\n'); printf("Invalid ID.\n"); return; }
    while(getchar() != '\n');
    size_t idx = (size_t)-1;
    for (size_t i = 0; i < account_count; ++i) if (accounts[i].id == id) { idx = i; break; }
    if (idx == (size_t)-1) { printf("Account not found.\n"); return; }
    if (!authenticate(&accounts[idx])) return;
    /* shift left */
    for (size_t i = idx; i + 1 < account_count; ++i) accounts[i] = accounts[i + 1];
    account_count--;
    if (account_count == 0) { free(accounts); accounts = NULL; }
    else {
        Account *tmp = realloc(accounts, account_count * sizeof(Account));
        if (tmp) accounts = tmp;
    }
    save_accounts();
    printf("Account deleted.\n");
}

int main(void) {
    load_accounts();

    printf("Welcome to Mini Banking System (C)\n");

    for (;;) {
        printf("\nAvailable commands:\n");
        printf(" 1. Create account\n");
        printf(" 2. View account\n");
        printf(" 3. Deposit\n");
        printf(" 4. Withdraw\n");
        printf(" 5. Transfer\n");
        printf(" 6. List all accounts\n");
        printf(" 7. Delete account\n");
        printf(" 0. Quit\n");
        printf("Choose: ");
        int choice = -1;
        if (scanf("%d", &choice) != 1) { while(getchar() != '\n'); printf("Invalid input.\n"); continue; }
        while(getchar() != '\n');
        switch (choice) {
            case 1: cmd_create(); break;
            case 2: cmd_view(); break;
            case 3: cmd_deposit(); break;
            case 4: cmd_withdraw(); break;
            case 5: cmd_transfer(); break;
            case 6: cmd_list(); break;
            case 7: cmd_delete(); break;
            case 0: printf("Goodbye!\n"); free(accounts); return 0;
            default: printf("Unknown choice.\n"); break;
        }
    }
}
